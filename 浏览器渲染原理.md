#### 渲染流程

构建DOM树 -> 样式计算 -> 生成布局树（layout tree） -> 生成图层树（layer tree） -> 生成待绘制列表提交给合成线程 -> 栅格化 -> 显示

##### 构建DOM树

首先浏览器渲染进程的主线程将html解析为DOM树

##### 样式计算

根据css继承规则和层叠规则计算每个节点的样式

##### 布局阶段

DOM树和样式构建完成后，需要计算DOM树中可见元素的几何信息

1. 创建布局树（layout tree），遍历DOM所有可见节点，将其添加到布局树中，如display: none的元素会被忽略

2. 布局计算，生成layout tree后，计算每个节点的坐标位置

##### 分层

页面中有很多复杂的效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-index 做 z 轴排序等，为了更加方便地实现这些效果，渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树（LayerTree）

渲染引擎给页面分了很多图层，这些图层按照一定顺序叠加在一起，就形成了最终的页面。通常情况下，并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层

满足下面两点中任意一点的元素创建新的图层

1. 拥有层叠上下文属性的元素会被提升为单独的一层

- 根元素html
- position 值为 absolute 或 relative且 z-index 值不为 auto 的元素
- position 值为 fixed 或 sticky 的元素
- flex 容器的子元素，且 z-index 值不为 auto
- grid 容器的子元素，且 z-index 值不为 auto
- opacity 属性值小于 1 的元素

2. 需要剪裁的地方也会被创建为图层

如果把 div 的大小限定为 200 * 200 像素，而 div 里面的文字内容比较多，文字所显示的区域肯定会超出 200 * 200 的面积，这时候就产生了剪裁，渲染引擎会把裁剪文字内容的一部分用于显示在 div 区域，出现这种裁剪情况的时候，渲染引擎会为文字部分单独创建一个层，如果出现滚动条，滚动条也会被提升为单独的层

##### 图层绘制

layer tree构建完成后，渲染引擎将每个图层拆分成小的绘制指令，再将这些指令按顺序组成待绘制列表

![image](https://pic1.zhimg.com/80/v2-f618a42e7fcf7e565513376f099aa640_1440w.jpg)

至此，上述操作均在渲染进程的主线程完成

##### 栅格化（raster）

当图层的绘制列表准备好之后，主线程会把该绘制列表提交给合成线程，合成线程会将图层划分为图块（tile），按照视口（viewport）附近的图块来优先生成位图，实际生成位图的操作是由栅格化来执行的。所谓栅格化，是指将图块转换为位图

图块是栅格化执行的最小单位。渲染进程维护了一个栅格化的线程池，所有的图块栅格化都是在线程池内执行的

![image](https://pic4.zhimg.com/80/v2-ef4066203badce5e880732234ec4a8cf_1440w.jpg)

通常，栅格化过程都会使用 GPU 来加速生成，使用 GPU 生成位图的过程叫快速栅格化，或者 GPU 栅格化，生成的位图被保存在 GPU 内存中，这就涉及到与GPU进程的跨进程操作

![image](https://pic1.zhimg.com/80/v2-87d0635f049e8a572932607baa45e640_1440w.jpg)

##### 显示

当所有图块被栅格化后，合成线程生成一个绘制图块的命令提交给浏览器进程，然后生成页面

#### 重排、重绘、合成

1. 重排

修改元素的几何属性会触发重排，会触发style（计算样式）后的所有流程，开销大

![image](https://pic1.zhimg.com/80/v2-88eb76703f5765c5889e44140ec549b8_1440w.jpg)

2. 重绘

修改元素的绘制属性会触发重绘，会跳过layout和layer阶段，性能好于重排

![image](https://pic2.zhimg.com/80/v2-146e92c0b2d807fe77f9e121deda4691_1440w.jpg)

3. 合成

使用 CSS 的 transform 来实现动画效果，可以避开重排和重绘阶段，直接在非主线程上执行合成动画操作，性能最好

![image](https://pic1.zhimg.com/80/v2-62f789340c5d1882aff5f6e2e930bb58_1440w.jpg)

参考文档

1. [浏览器渲染流程](https://zhuanlan.zhihu.com/p/162722524)